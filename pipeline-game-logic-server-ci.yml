# Game Logic build and release pipeline
# This pipeline is respsonsible for building the game logic code and pushing it to the artifact repository
# as a nuget package.

name: $(Rev:r)

trigger:
  branches:
    include:
    - develop
  paths:
    include:
    - Backend
    - pipeline-game-logic-server-ci.yml

resources:
  repositories:
  - repository: self
  - repository: templates
    type: bitbucket
    endpoint: bitbucket
    ref: feature/add-image-ref-step
    name: first-light/infrastructure
    
variables:
- group: Non-secrets
- name: serviceConnection
  value: AzureRM
- name: repository
  value: 'gamelogic'
- name: dockerfile
  value: ContainerApp/Dockerfile
- name: vmImageName
  value: 'ubuntu-latest'

pool:
  vmImage: $(vmImageName)

stages:
- stage: Build
  displayName: Build and push image
  jobs:
    - job: BuildPush
      displayName: Build and push
      steps:
      - checkout: self
        lfs: true
        submodules: true
      - template: pipelines/templates/docker-build-push.yml@templates
        parameters:
          serviceConnection: $(serviceConnection)
          containerRegistry: $(REGISTRY_NAME)
          repository: $(repository)
          workingDirectory: Backend
          buildArgs: |
            -f $(dockerfile) . --no-cache
